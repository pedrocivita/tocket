# System Patterns - Tocket

## Architecture

```
┌───────────────────────────────────────────────────────┐
│                      tocket CLI                       │
│                                                       │
│  index.ts ─── Commander program + dashboard detection │
│     ├── init.cmd.ts       (scaffold workspace)        │
│     ├── generate.cmd.ts   (build payload XML)         │
│     ├── sync.cmd.ts       (update Memory Bank)        │
│     ├── validate.cmd.ts   (health check)              │
│     ├── config.cmd.ts     (global settings TUI)       │
│     ├── focus.cmd.ts      (update Current Focus)      │
│     ├── status.cmd.ts     (quick workspace overview)  │
│     ├── doctor.cmd.ts     (deep diagnostics)          │
│     ├── lint.cmd.ts       (context quality audit)     │
│     ├── eject.cmd.ts      (remove scaffolding)        │
│     └── dashboard.ts      (interactive menu, no-args) │
│                                                       │
│  templates/                                           │
│     └── memory-bank.ts    (file content generators)   │
│                                                       │
│  utils/                                               │
│     ├── theme.ts          (purple theme, banner)      │
│     ├── git.ts            (git wrappers)              │
│     ├── config.ts         (~/.tocketrc.json)          │
│     └── context.ts        (shared constants/helpers)  │
└───────────────────────────────────────────────────────┘
```

## Patterns

### Command Registration

Commands follow a consistent pattern: one file per command, exporting a `register*Command` function that receives the Commander `program` instance.

```typescript
// src/commands/foo.cmd.ts
import type { Command } from "commander";

export function registerFooCommand(program: Command): void {
  program
    .command("foo")
    .description("Does something")
    .action(async () => { /* ... */ });
}
```

### Template Functions

Scaffolded file contents are generated by pure functions in `src/templates/`. Each function takes project metadata and returns a markdown string.

```typescript
export const fooMd = (projectName: string, description: string) => `...`;
```

### Triangulation Protocol

The core workflow Tocket enables:

```
Architect (Gemini)          Executor (Claude)
     │                           │
     │  1. Read .context/        │
     │  2. Analyze task          │
     │  3. Generate <payload>    │
     │──── XML handoff ─────────►│
     │                           │  4. Verify pre-flight
     │                           │  5. Execute tasks
     │                           │  6. Update .context/
     │◄── Status report ─────────│
```

### Memory Bank Protocol

Files in `.context/` follow a fixed schema:

| File | Owner | Update Frequency |
|------|-------|-----------------|
| `activeContext.md` | Both agents | Every session |
| `productContext.md` | Architect | Rarely |
| `techContext.md` | Architect | When stack changes |
| `systemPatterns.md` | Architect | When patterns change |
| `progress.md` | Executor / `tocket sync` | Per milestone |

## Conventions

- Code language: `en-US`
- Commit language: `en-US`
- File naming: `kebab-case` for files, `camelCase` for exports
- Command files: `<name>.cmd.ts`
- No default exports — always named exports

## Key Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| ESM-only (`"type": "module"`) | Modern Node.js standard, tree-shakeable | 2026-02-24 |
| Commander.js for CLI | Mature, well-documented, supports subcommands | 2026-02-24 |
| `.context/` committed to git | Shared context must survive across clones | 2026-02-24 |
| Payload XML as handoff format | Structured, parseable, version-tagged | 2026-02-24 |
| Clipboard output for `generate` | Fastest path from CLI to Architect IDE panel | 2026-02-24 |
